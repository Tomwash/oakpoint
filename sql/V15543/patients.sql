
                        -- Declare JSON Variable
                        declare @json nvarchar(max) = 
                        (
                            SELECT
                               '[' + CAST(BulkColumn AS NVARCHAR(MAX)) + ']' AS JsonData 
                            FROM 
                            OPENROWSET(BULK 'oakpoint-data/streams/V15543/patients.json', DATA_SOURCE = 'OakpointDataV1', SINGLE_CLOB) AS AzureBlob 
                        ); 

                        -- Declare Temp Table
                        Declare @TableView TABLE 
                        ( 
                            ID bigint NOT NULL PRIMARY KEY IDENTITY(1, 1),
                            col_href varchar(8000),col_patient_id varchar(8000),col_guarantor_id varchar(8000),col_firstname varchar(8000),col_middlename varchar(8000),col_lastname varchar(8000),col_preferred_name varchar(8000),col_salutation varchar(8000),col_birthdate varchar(8000),col_status varchar(8000),col_patient_note varchar(8000),col_medical_note varchar(8000),col_alert_note varchar(8000),col_other_note varchar(8000),col_gender varchar(8000),col_marital_status varchar(8000),col_address_line1 varchar(8000),col_address_line2 varchar(8000),col_city varchar(8000),col_state varchar(8000),col_zipcode varchar(8000),col_homephone varchar(8000),col_workphone varchar(8000),col_cell varchar(8000),col_email varchar(8000),col_employer_id varchar(8000),col_employer varchar(8000),col_billing_type varchar(8000),col_first_visit varchar(8000),col_last_visit varchar(8000),col_referred_by_patient_id varchar(8000),col_provider_id varchar(8000),col_provider varchar(8000),col_practice_id varchar(8000),col_practice varchar(8000),col_appointments varchar(8000),col_guarantor varchar(8000),col_primary_insurance_company_id varchar(8000),col_primary_insurance_company varchar(8000),col_secondary_insurance_company_id varchar(8000),col_secondary_insurance_company varchar(8000),col_secondary_relationship varchar(8000),col_breed varchar(8000),col_species varchar(8000),col_color varchar(8000),col_weight varchar(8000),col_weight_type varchar(8000),col_height varchar(8000),col_age varchar(8000),col_code varchar(8000),col_suspended_date varchar(8000),col_deceased_date varchar(8000),col_rabies varchar(8000),col_feed varchar(8000),col_diet varchar(8000),col_pet_class varchar(8000),col_certificate varchar(8000),col_epet_record_id varchar(8000),col_microchip varchar(8000),col_trainer varchar(8000),col_registered_name varchar(8000),col_plan varchar(8000),col_relative_name varchar(8000),col_codes varchar(8000),col_mixed varchar(8000),col_added_by varchar(8000),col_other_referral varchar(8000),col_patient_referral varchar(8000),col_referred_out varchar(8000),col_referred_by_provider_id varchar(8000),col_fee_no varchar(8000),col_guarantor_first_name varchar(8000),col_guarantor_last_name varchar(8000),col_created_date varchar(8000),col_family_veterinarian varchar(8000),col_patient_codes varchar(8000),col_primary_insurance varchar(8000),col_secondary_insurance varchar(8000),col_other_phone varchar(8000),col_preferred_communication_method varchar(8000),created_at datetime, updated_at datetime, office_id varchar(2000), practice_name varchar(2000)
                        ); 

                        INSERT INTO @TableView
                            ([col_href],[col_patient_id],[col_guarantor_id],[col_firstname],[col_middlename],[col_lastname],[col_preferred_name],[col_salutation],[col_birthdate],[col_status],[col_patient_note],[col_medical_note],[col_alert_note],[col_other_note],[col_gender],[col_marital_status],[col_address_line1],[col_address_line2],[col_city],[col_state],[col_zipcode],[col_homephone],[col_workphone],[col_cell],[col_email],[col_employer_id],[col_employer],[col_billing_type],[col_first_visit],[col_last_visit],[col_referred_by_patient_id],[col_provider_id],[col_provider],[col_practice_id],[col_practice],[col_appointments],[col_guarantor],[col_primary_insurance_company_id],[col_primary_insurance_company],[col_secondary_insurance_company_id],[col_secondary_insurance_company],[col_secondary_relationship],[col_breed],[col_species],[col_color],[col_weight],[col_weight_type],[col_height],[col_age],[col_code],[col_suspended_date],[col_deceased_date],[col_rabies],[col_feed],[col_diet],[col_pet_class],[col_certificate],[col_epet_record_id],[col_microchip],[col_trainer],[col_registered_name],[col_plan],[col_relative_name],[col_codes],[col_mixed],[col_added_by],[col_other_referral],[col_patient_referral],[col_referred_out],[col_referred_by_provider_id],[col_fee_no],[col_guarantor_first_name],[col_guarantor_last_name],[col_created_date],[col_family_veterinarian],[col_patient_codes],[col_primary_insurance],[col_secondary_insurance],[col_other_phone],[col_preferred_communication_method],created_at, updated_at, office_id, practice_name)
                            SELECT *,
                            '2020-05-21T02:22:24.351Z',
                            '2020-05-21T02:22:24.351Z',
                            'V15543',
                            '' FROM OPENJSON(@json)  
                            WITH  
                            (
                                    col_href varchar(8000) '$.href',col_patient_id varchar(8000) '$.patient_id',col_guarantor_id varchar(8000) '$.guarantor_id',col_firstname varchar(8000) '$.firstname',col_middlename varchar(8000) '$.middlename',col_lastname varchar(8000) '$.lastname',col_preferred_name varchar(8000) '$.preferred_name',col_salutation varchar(8000) '$.salutation',col_birthdate varchar(8000) '$.birthdate',col_status varchar(8000) '$.status',col_patient_note varchar(8000) '$.patient_note',col_medical_note varchar(8000) '$.medical_note',col_alert_note varchar(8000) '$.alert_note',col_other_note varchar(8000) '$.other_note',col_gender varchar(8000) '$.gender',col_marital_status varchar(8000) '$.marital_status',col_address_line1 varchar(8000) '$.address_line1',col_address_line2 varchar(8000) '$.address_line2',col_city varchar(8000) '$.city',col_state varchar(8000) '$.state',col_zipcode varchar(8000) '$.zipcode',col_homephone varchar(8000) '$.homephone',col_workphone varchar(8000) '$.workphone',col_cell varchar(8000) '$.cell',col_email varchar(8000) '$.email',col_employer_id varchar(8000) '$.employer_id',col_employer varchar(8000) '$.employer',col_billing_type varchar(8000) '$.billing_type',col_first_visit varchar(8000) '$.first_visit',col_last_visit varchar(8000) '$.last_visit',col_referred_by_patient_id varchar(8000) '$.referred_by_patient_id',col_provider_id varchar(8000) '$.provider_id',col_provider varchar(8000) '$.provider',col_practice_id varchar(8000) '$.practice_id',col_practice varchar(8000) '$.practice',col_appointments varchar(8000) '$.appointments',col_guarantor varchar(8000) '$.guarantor',col_primary_insurance_company_id varchar(8000) '$.primary_insurance_company_id',col_primary_insurance_company varchar(8000) '$.primary_insurance_company',col_secondary_insurance_company_id varchar(8000) '$.secondary_insurance_company_id',col_secondary_insurance_company varchar(8000) '$.secondary_insurance_company',col_secondary_relationship varchar(8000) '$.secondary_relationship',col_breed varchar(8000) '$.breed',col_species varchar(8000) '$.species',col_color varchar(8000) '$.color',col_weight varchar(8000) '$.weight',col_weight_type varchar(8000) '$.weight_type',col_height varchar(8000) '$.height',col_age varchar(8000) '$.age',col_code varchar(8000) '$.code',col_suspended_date varchar(8000) '$.suspended_date',col_deceased_date varchar(8000) '$.deceased_date',col_rabies varchar(8000) '$.rabies',col_feed varchar(8000) '$.feed',col_diet varchar(8000) '$.diet',col_pet_class varchar(8000) '$.pet_class',col_certificate varchar(8000) '$.certificate',col_epet_record_id varchar(8000) '$.epet_record_id',col_microchip varchar(8000) '$.microchip',col_trainer varchar(8000) '$.trainer',col_registered_name varchar(8000) '$.registered_name',col_plan varchar(8000) '$.plan',col_relative_name varchar(8000) '$.relative_name',col_codes varchar(8000) '$.codes',col_mixed varchar(8000) '$.mixed',col_added_by varchar(8000) '$.added_by',col_other_referral varchar(8000) '$.other_referral',col_patient_referral varchar(8000) '$.patient_referral',col_referred_out varchar(8000) '$.referred_out',col_referred_by_provider_id varchar(8000) '$.referred_by_provider_id',col_fee_no varchar(8000) '$.fee_no',col_guarantor_first_name varchar(8000) '$.guarantor_first_name',col_guarantor_last_name varchar(8000) '$.guarantor_last_name',col_created_date varchar(8000) '$.created_date',col_family_veterinarian varchar(8000) '$.family_veterinarian',col_patient_codes varchar(8000) '$.patient_codes',col_primary_insurance varchar(8000) '$.primary_insurance',col_secondary_insurance varchar(8000) '$.secondary_insurance',col_other_phone varchar(8000) '$.other_phone',col_preferred_communication_method varchar(8000) '$.preferred_communication_method'
                            );

                        WITH CTE AS(
                            SELECT col_href,
                                RN = ROW_NUMBER()OVER(PARTITION BY col_href ORDER BY col_href)
                            FROM @TableView
                        )
                        DELETE FROM CTE WHERE RN > 1
                         
                        MERGE patients original
                        USING @TableView modified
                        ON original.col_href = modified.col_href
                        WHEN MATCHED 
                            THEN UPDATE SET 
                            original.[col_href] = modified.[col_href],original.[col_patient_id] = modified.[col_patient_id],original.[col_guarantor_id] = modified.[col_guarantor_id],original.[col_firstname] = modified.[col_firstname],original.[col_middlename] = modified.[col_middlename],original.[col_lastname] = modified.[col_lastname],original.[col_preferred_name] = modified.[col_preferred_name],original.[col_salutation] = modified.[col_salutation],original.[col_birthdate] = modified.[col_birthdate],original.[col_status] = modified.[col_status],original.[col_patient_note] = modified.[col_patient_note],original.[col_medical_note] = modified.[col_medical_note],original.[col_alert_note] = modified.[col_alert_note],original.[col_other_note] = modified.[col_other_note],original.[col_gender] = modified.[col_gender],original.[col_marital_status] = modified.[col_marital_status],original.[col_address_line1] = modified.[col_address_line1],original.[col_address_line2] = modified.[col_address_line2],original.[col_city] = modified.[col_city],original.[col_state] = modified.[col_state],original.[col_zipcode] = modified.[col_zipcode],original.[col_homephone] = modified.[col_homephone],original.[col_workphone] = modified.[col_workphone],original.[col_cell] = modified.[col_cell],original.[col_email] = modified.[col_email],original.[col_employer_id] = modified.[col_employer_id],original.[col_employer] = modified.[col_employer],original.[col_billing_type] = modified.[col_billing_type],original.[col_first_visit] = modified.[col_first_visit],original.[col_last_visit] = modified.[col_last_visit],original.[col_referred_by_patient_id] = modified.[col_referred_by_patient_id],original.[col_provider_id] = modified.[col_provider_id],original.[col_provider] = modified.[col_provider],original.[col_practice_id] = modified.[col_practice_id],original.[col_practice] = modified.[col_practice],original.[col_appointments] = modified.[col_appointments],original.[col_guarantor] = modified.[col_guarantor],original.[col_primary_insurance_company_id] = modified.[col_primary_insurance_company_id],original.[col_primary_insurance_company] = modified.[col_primary_insurance_company],original.[col_secondary_insurance_company_id] = modified.[col_secondary_insurance_company_id],original.[col_secondary_insurance_company] = modified.[col_secondary_insurance_company],original.[col_secondary_relationship] = modified.[col_secondary_relationship],original.[col_breed] = modified.[col_breed],original.[col_species] = modified.[col_species],original.[col_color] = modified.[col_color],original.[col_weight] = modified.[col_weight],original.[col_weight_type] = modified.[col_weight_type],original.[col_height] = modified.[col_height],original.[col_age] = modified.[col_age],original.[col_code] = modified.[col_code],original.[col_suspended_date] = modified.[col_suspended_date],original.[col_deceased_date] = modified.[col_deceased_date],original.[col_rabies] = modified.[col_rabies],original.[col_feed] = modified.[col_feed],original.[col_diet] = modified.[col_diet],original.[col_pet_class] = modified.[col_pet_class],original.[col_certificate] = modified.[col_certificate],original.[col_epet_record_id] = modified.[col_epet_record_id],original.[col_microchip] = modified.[col_microchip],original.[col_trainer] = modified.[col_trainer],original.[col_registered_name] = modified.[col_registered_name],original.[col_plan] = modified.[col_plan],original.[col_relative_name] = modified.[col_relative_name],original.[col_codes] = modified.[col_codes],original.[col_mixed] = modified.[col_mixed],original.[col_added_by] = modified.[col_added_by],original.[col_other_referral] = modified.[col_other_referral],original.[col_patient_referral] = modified.[col_patient_referral],original.[col_referred_out] = modified.[col_referred_out],original.[col_referred_by_provider_id] = modified.[col_referred_by_provider_id],original.[col_fee_no] = modified.[col_fee_no],original.[col_guarantor_first_name] = modified.[col_guarantor_first_name],original.[col_guarantor_last_name] = modified.[col_guarantor_last_name],original.[col_created_date] = modified.[col_created_date],original.[col_family_veterinarian] = modified.[col_family_veterinarian],original.[col_patient_codes] = modified.[col_patient_codes],original.[col_primary_insurance] = modified.[col_primary_insurance],original.[col_secondary_insurance] = modified.[col_secondary_insurance],original.[col_other_phone] = modified.[col_other_phone],original.[col_preferred_communication_method] = modified.[col_preferred_communication_method],
                        original.updated_at = '2020-05-21T02:22:24.351Z',
                        original.office_id = 'V15543',
                        practice_name = ''
                        WHEN NOT MATCHED BY TARGET THEN
                        INSERT  
                        (
                            [col_href],[col_patient_id],[col_guarantor_id],[col_firstname],[col_middlename],[col_lastname],[col_preferred_name],[col_salutation],[col_birthdate],[col_status],[col_patient_note],[col_medical_note],[col_alert_note],[col_other_note],[col_gender],[col_marital_status],[col_address_line1],[col_address_line2],[col_city],[col_state],[col_zipcode],[col_homephone],[col_workphone],[col_cell],[col_email],[col_employer_id],[col_employer],[col_billing_type],[col_first_visit],[col_last_visit],[col_referred_by_patient_id],[col_provider_id],[col_provider],[col_practice_id],[col_practice],[col_appointments],[col_guarantor],[col_primary_insurance_company_id],[col_primary_insurance_company],[col_secondary_insurance_company_id],[col_secondary_insurance_company],[col_secondary_relationship],[col_breed],[col_species],[col_color],[col_weight],[col_weight_type],[col_height],[col_age],[col_code],[col_suspended_date],[col_deceased_date],[col_rabies],[col_feed],[col_diet],[col_pet_class],[col_certificate],[col_epet_record_id],[col_microchip],[col_trainer],[col_registered_name],[col_plan],[col_relative_name],[col_codes],[col_mixed],[col_added_by],[col_other_referral],[col_patient_referral],[col_referred_out],[col_referred_by_provider_id],[col_fee_no],[col_guarantor_first_name],[col_guarantor_last_name],[col_created_date],[col_family_veterinarian],[col_patient_codes],[col_primary_insurance],[col_secondary_insurance],[col_other_phone],[col_preferred_communication_method],created_at, updated_at, office_id, practice_name
                        )
                        VALUES
                        (
                            modified.[col_href],modified.[col_patient_id],modified.[col_guarantor_id],modified.[col_firstname],modified.[col_middlename],modified.[col_lastname],modified.[col_preferred_name],modified.[col_salutation],modified.[col_birthdate],modified.[col_status],modified.[col_patient_note],modified.[col_medical_note],modified.[col_alert_note],modified.[col_other_note],modified.[col_gender],modified.[col_marital_status],modified.[col_address_line1],modified.[col_address_line2],modified.[col_city],modified.[col_state],modified.[col_zipcode],modified.[col_homephone],modified.[col_workphone],modified.[col_cell],modified.[col_email],modified.[col_employer_id],modified.[col_employer],modified.[col_billing_type],modified.[col_first_visit],modified.[col_last_visit],modified.[col_referred_by_patient_id],modified.[col_provider_id],modified.[col_provider],modified.[col_practice_id],modified.[col_practice],modified.[col_appointments],modified.[col_guarantor],modified.[col_primary_insurance_company_id],modified.[col_primary_insurance_company],modified.[col_secondary_insurance_company_id],modified.[col_secondary_insurance_company],modified.[col_secondary_relationship],modified.[col_breed],modified.[col_species],modified.[col_color],modified.[col_weight],modified.[col_weight_type],modified.[col_height],modified.[col_age],modified.[col_code],modified.[col_suspended_date],modified.[col_deceased_date],modified.[col_rabies],modified.[col_feed],modified.[col_diet],modified.[col_pet_class],modified.[col_certificate],modified.[col_epet_record_id],modified.[col_microchip],modified.[col_trainer],modified.[col_registered_name],modified.[col_plan],modified.[col_relative_name],modified.[col_codes],modified.[col_mixed],modified.[col_added_by],modified.[col_other_referral],modified.[col_patient_referral],modified.[col_referred_out],modified.[col_referred_by_provider_id],modified.[col_fee_no],modified.[col_guarantor_first_name],modified.[col_guarantor_last_name],modified.[col_created_date],modified.[col_family_veterinarian],modified.[col_patient_codes],modified.[col_primary_insurance],modified.[col_secondary_insurance],modified.[col_other_phone],modified.[col_preferred_communication_method],
                        '2020-05-21T02:22:24.351Z',
                        '2020-05-21T02:22:24.351Z',
                        'V15543',
                        ''
                        );
                    